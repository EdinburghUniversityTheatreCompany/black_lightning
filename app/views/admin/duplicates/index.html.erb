<%= render('shared/quick_actions_card') do %>
  <%= get_link(User, :index, link_text: "Back to Users") %>
<% end %>

<%
  # Helper to get years_active from cache if available, otherwise fall back to method call
  def cached_years_active(user, cache = nil)
    cache ? (cache[user.id] || []) : user.years_active
  end
%>

<% total_count = @duplicates[:same_id].size + @duplicates[:fuzzy_name_overlapping].size + @duplicates[:fuzzy_name_non_overlapping].size %>

<% if total_count == 0 %>
  <div class="alert alert-success">
    <strong>No potential duplicates found!</strong> All users appear to be unique.
  </div>
<% else %>

  <%# Bucket 1: Same ID (Definite Duplicates) %>
  <% if @duplicates[:same_id].any? %>
    <div class="card mb-3">
      <div class="card-header bg-danger text-white">
        <strong>Definite Duplicates (Same Student/Associate ID)</strong> - <%= @duplicates[:same_id].size %> group(s)
      </div>
      <div class="card-body">
        <p class="text-muted">These users share the same student or associate ID. They are almost certainly duplicates and should be merged.</p>
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>Match Type</th>
              <th>ID Value</th>
              <th>Users</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @duplicates[:same_id].each do |dup| %>
              <tr>
                <td><span class="badge bg-danger"><%= dup[:match_type].to_s.titleize %></span></td>
                <td><code><%= dup[:id_value] %></code></td>
                <td>
                  <% dup[:users].each do |user| %>
                    <% years = cached_years_active(user, dup[:years_active_cache]) %>
                    <%= link_to user.name_or_email, admin_user_path(user) %>
                    <small class="text-muted">(<%= user.email %>)</small>
                    <% if years.any? %>
                      <small class="text-muted">- Active: <%= years.map { |y| format_academic_year(y) }.join(", ") %></small>
                    <% end %>
                    <br>
                  <% end %>
                </td>
                <td>
                  <% target = dup[:users].first %>
                  <% source = dup[:users].second %>
                  <%= link_to "Merge", merge_admin_user_path(target, source_user_id: source.id), class: "btn btn-sm btn-warning" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <%# Bucket 2: Fuzzy Name Match with Overlapping Years %>
  <% if @duplicates[:fuzzy_name_overlapping].any? %>
    <div class="card mb-3">
      <div class="card-header bg-warning">
        <strong>Likely Duplicates (Name Match + Overlapping Activity)</strong> - <%= @duplicates[:fuzzy_name_overlapping].size %> pair(s)
      </div>
      <div class="card-body">
        <p class="text-muted">These users have matching last names, similar first names, and were active during overlapping time periods. They are likely the same person.</p>
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>User 1</th>
              <th>User 2</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @duplicates[:fuzzy_name_overlapping].each do |dup| %>
              <% u1, u2 = dup[:users] %>
              <% cache = dup[:years_active_cache] %>
              <% u1_years = cached_years_active(u1, cache) %>
              <% u2_years = cached_years_active(u2, cache) %>
              <tr>
                <td>
                  <%= link_to u1.name_or_email, admin_user_path(u1) %><br>
                  <small class="text-muted"><%= u1.email %></small><br>
                  <% if u1_years.any? %>
                    <small class="text-muted">Active: <%= u1_years.map { |y| format_academic_year(y) }.join(", ") %></small>
                  <% else %>
                    <small class="text-muted">No activity recorded</small>
                  <% end %>
                </td>
                <td>
                  <%= link_to u2.name_or_email, admin_user_path(u2) %><br>
                  <small class="text-muted"><%= u2.email %></small><br>
                  <% if u2_years.any? %>
                    <small class="text-muted">Active: <%= u2_years.map { |y| format_academic_year(y) }.join(", ") %></small>
                  <% else %>
                    <small class="text-muted">No activity recorded</small>
                  <% end %>
                </td>
                <td>
                  <%= link_to "Merge", merge_admin_user_path(u1, source_user_id: u2.id), class: "btn btn-sm btn-warning" %>
                  <%= button_to "Not Duplicates", mark_not_duplicate_admin_duplicates_path(user_id: u1.id, other_user_id: u2.id), method: :post, class: "btn btn-sm btn-secondary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <%# Bucket 3: Fuzzy Name Match without Overlapping Years %>
  <% if @duplicates[:fuzzy_name_non_overlapping].any? %>
    <div class="card mb-3">
      <div class="card-header bg-info text-white">
        <strong>Possible Duplicates (Name Match, Different Time Periods)</strong> - <%= @duplicates[:fuzzy_name_non_overlapping].size %> pair(s)
      </div>
      <div class="card-body">
        <p class="text-muted">These users have matching names but were active in different time periods (more than 4 years apart). They are less likely to be the same person, but you may want to review them.</p>
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>User 1</th>
              <th>User 2</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @duplicates[:fuzzy_name_non_overlapping].each do |dup| %>
              <% u1, u2 = dup[:users] %>
              <% cache = dup[:years_active_cache] %>
              <% u1_years = cached_years_active(u1, cache) %>
              <% u2_years = cached_years_active(u2, cache) %>
              <tr>
                <td>
                  <%= link_to u1.name_or_email, admin_user_path(u1) %><br>
                  <small class="text-muted"><%= u1.email %></small><br>
                  <% if u1_years.any? %>
                    <small class="text-muted">Active: <%= u1_years.map { |y| format_academic_year(y) }.join(", ") %></small>
                  <% else %>
                    <small class="text-muted">No activity recorded</small>
                  <% end %>
                </td>
                <td>
                  <%= link_to u2.name_or_email, admin_user_path(u2) %><br>
                  <small class="text-muted"><%= u2.email %></small><br>
                  <% if u2_years.any? %>
                    <small class="text-muted">Active: <%= u2_years.map { |y| format_academic_year(y) }.join(", ") %></small>
                  <% else %>
                    <small class="text-muted">No activity recorded</small>
                  <% end %>
                </td>
                <td>
                  <%= link_to "Merge", merge_admin_user_path(u1, source_user_id: u2.id), class: "btn btn-sm btn-warning" %>
                  <%= button_to "Not Duplicates", mark_not_duplicate_admin_duplicates_path(user_id: u1.id, other_user_id: u2.id), method: :post, class: "btn btn-sm btn-secondary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

<% end %>
