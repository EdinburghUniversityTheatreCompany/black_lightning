<%= render('shared/quick_actions_card') do %>
  <%= link_to "Cancel", new_admin_user_import_path, class: "btn btn-secondary" %>
<% end %>

<% total = @import.rows.size %>
<div class="alert alert-info">
  <strong>Found <%= total %> row(s) to process.</strong>
  Review the categorization below and adjust decisions as needed.
</div>

<%= form_with url: confirm_admin_user_imports_path, method: :post, local: true do |f| %>
  <%# Bucket 1: Exact match by ID %>
  <% if @import.categorized[:exact_match_id].any? %>
    <div class="card mb-3">
      <div class="card-header bg-success text-white">
        <strong>Matched by Student/Associate ID</strong>
        <span class="badge bg-light text-dark ms-2"><%= @import.categorized[:exact_match_id].size %></span>
        <small class="float-end">Users already exist - no action needed</small>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Import Name</th>
              <th>Existing User</th>
              <th>ID Match</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% @import.categorized[:exact_match_id].each do |item| %>
              <tr class="table-success">
                <td><%= item[:row][:original_name] %></td>
                <td><%= link_to item[:existing_user].name_or_email, admin_user_path(item[:existing_user]) %></td>
                <td><span class="font-monospace"><%= item[:row][:student_id] || item[:row][:associate_id] %></span></td>
                <td>
                  <input type="hidden" name="actions[<%= item[:index] %>]" value="link">
                  <span class="badge bg-success">Already Exists</span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <%# Bucket 2: Exact match by email %>
  <% if @import.categorized[:exact_match_email].any? %>
    <div class="card mb-3">
      <div class="card-header bg-success text-white">
        <strong>Matched by Email</strong>
        <span class="badge bg-light text-dark ms-2"><%= @import.categorized[:exact_match_email].size %></span>
        <small class="float-end">Users already exist - no action needed</small>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Import Name</th>
              <th>Existing User</th>
              <th>Email Match</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% @import.categorized[:exact_match_email].each do |item| %>
              <tr class="table-success">
                <td><%= item[:row][:original_name] %></td>
                <td><%= link_to item[:existing_user].name_or_email, admin_user_path(item[:existing_user]) %></td>
                <td><span class="font-monospace"><%= item[:row][:email] %></span></td>
                <td>
                  <input type="hidden" name="actions[<%= item[:index] %>]" value="link">
                  <span class="badge bg-success">Already Exists</span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <%# Bucket 3: Fuzzy name match - needs review %>
  <% if @import.categorized[:fuzzy_match].any? %>
    <div class="card mb-3">
      <div class="card-header bg-warning">
        <strong>Possible Matches (Review Required)</strong>
        <span class="badge bg-dark ms-2"><%= @import.categorized[:fuzzy_match].size %></span>
        <small class="float-end">Please decide for each row</small>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Import Data</th>
              <th>Possible Match</th>
              <th style="width: 200px;">Decision</th>
            </tr>
          </thead>
          <tbody>
            <% @import.categorized[:fuzzy_match].each do |item| %>
              <tr>
                <td>
                  <strong><%= item[:row][:original_name] %></strong><br>
                  <% if item[:row][:email].present? %>
                    <small class="text-muted"><%= item[:row][:email] %></small>
                  <% end %>
                  <% if item[:row][:student_id] || item[:row][:associate_id] %>
                    <br><small class="text-muted">ID: <%= item[:row][:student_id] || item[:row][:associate_id] %></small>
                  <% end %>
                </td>
                <td>
                  <%= link_to item[:existing_user].name_or_email, admin_user_path(item[:existing_user]) %><br>
                  <small class="text-muted"><%= item[:existing_user].email %></small>
                  <% if item[:existing_user].student_id.present? %>
                    <br><small class="text-muted">ID: <%= item[:existing_user].student_id %></small>
                  <% end %>
                </td>
                <td>
                  <select name="actions[<%= item[:index] %>]" class="form-select form-select-sm">
                    <option value="link">Same person (link)</option>
                    <option value="create">Different person (create new)</option>
                    <option value="skip">Skip</option>
                  </select>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <%# Bucket 4: Create new %>
  <% if @import.categorized[:create_new].any? %>
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">
        <strong>New Users to Create</strong>
        <span class="badge bg-light text-dark ms-2"><%= @import.categorized[:create_new].size %></span>
        <small class="float-end">Will create new user accounts</small>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>ID</th>
              <th style="width: 150px;">Action</th>
            </tr>
          </thead>
          <tbody>
            <% @import.categorized[:create_new].each do |item| %>
              <tr>
                <td><%= item[:row][:original_name] %></td>
                <td>
                  <% if item[:row][:email].present? %>
                    <span class="font-monospace"><%= item[:row][:email] %></span>
                    <% if item[:row][:student_id].present? && item[:row][:email] == "#{item[:row][:student_id]}@ed.ac.uk" %>
                      <br><small class="text-muted">(auto-generated)</small>
                    <% end %>
                  <% else %>
                    <em class="text-muted">(will generate placeholder)</em>
                  <% end %>
                </td>
                <td>
                  <% if item[:row][:student_id] || item[:row][:associate_id] %>
                    <span class="font-monospace"><%= item[:row][:student_id] || item[:row][:associate_id] %></span>
                  <% else %>
                    <em class="text-muted">-</em>
                  <% end %>
                </td>
                <td>
                  <select name="actions[<%= item[:index] %>]" class="form-select form-select-sm">
                    <option value="create">Create</option>
                    <option value="skip">Skip</option>
                  </select>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <div class="card">
    <div class="card-footer d-flex justify-content-between">
      <%= link_to "Cancel", new_admin_user_import_path, class: "btn btn-secondary" %>
      <%= f.submit "Confirm Import", class: "btn btn-success" %>
    </div>
  </div>
<% end %>
