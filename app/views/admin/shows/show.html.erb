<% content_for :extra_show_actions do %>
    <% if @show.xts_id && can?(:edit, @show) %>
        <%= link_to xts_report_admin_show_path(@show), class: "btn btn-secondary" do %>
            <i class='fas fa-shopping-basket' aria-hidden=”true”></i> XTS Report
        <% end %>
    <% end %>

    <%= get_link Admin::Feedback, :new, link_text: "Submit Feedback", link_target: new_admin_show_feedback_path(@show), html_class: 'btn btn-secondary' %>

    <%= get_link Admin::Feedback, :index, link_text: 'Show Feedback', link_target: admin_show_feedbacks_path(@show), 
                additional_condition: @show.feedbacks.any? 
    %>

    <%= get_link @show, :convert_to_season, condition: can?(:create, Season) && can?(:destroy, @show), http_method: :post,
                confirm: "Converting Show #{@show.name} into Season", detail: "Are you sure you want to convert the Show into a Season? Make sure there are no reviews or feedbacks attached before proceeding. You cannot undo this action." 
    %>

    <%= get_link @show, :convert_to_workshop, condition: can?(:create, Workshop) && can?(:destroy, @show), http_method: :post,
                confirm: "Converting Show #{@show.name} into Season", detail: "Are you sure you want to convert the Show into a Workshop? Make sure there are no reviews or feedbacks attached before proceeding. You cannot undo this action." 
    %>
<% end %>

<% extra_fields = {
  reviews:   { type: 'content', header: 'Reviews', content: render('/admin/events/reviews', reviews: @show.reviews) }
} %>

<% # Only show the Debt stuff if the show is in the current academic year. %>
<% if @show.end_date > start_of_year && (can?(:create, Admin::MaintenanceDebt) || can?(:create, Admin::StaffingDebt)) %>
    <% content_for :debt_settings do %>
        <p>
            Configure the number of debts to assign to team members. Once configured, debts will be
            automatically created when team members are added to the show. Saving these settings will
            also sync debts for all existing team members.
        </p>
        <p>
            <strong>Position rules:</strong> Assistants (all roles must be assistant) get max 1 staffing debt.
            Welfare contacts (if their only role) get 0 staffing debts.
        </p>

        <%= simple_horizontal_form_for @show, url: update_debt_settings_admin_show_path(@show), method: :patch do |f| %>
            <%= f.error_notification %>

            <div class="row">
                <div class="col-md-6">
                    <h5>Maintenance Debts</h5>
                    <%= f.input :maintenance_debt_amount, label: 'Amount per person', as: :integer, min: 0, max: 5,
                                hint: 'Leave blank or set to 0 to disable auto-creation' %>
                    <%= f.input :maintenance_debt_start, as: :date, label: 'Due date',
                                default: ((@show.end_date || Date.current) + 14) %>
                </div>
                <div class="col-md-6">
                    <h5>Staffing Debts</h5>
                    <%= f.input :staffing_debt_amount, label: 'Amount per person', as: :integer, min: 0, max: 5,
                                hint: 'Leave blank or set to 0 to disable auto-creation' %>
                    <%= f.input :staffing_debt_start, as: :date, label: 'Due date',
                                default: ((@show.end_date || Date.current) + 14) %>
                </div>
            </div>

            <%= f.button :submit, value: 'Save Debt Settings', class: 'btn btn-primary' %>
        <% end %>

        <% if @show.debt_configuration_active? %>
            <hr>
            <p class="text-muted">
                <strong>Current configuration:</strong>
                <%= @show.maintenance_debt_amount.present? ? "#{@show.maintenance_debt_amount} maintenance debt(s)" : "No maintenance debts" %>
                &bull;
                <%= @show.staffing_debt_amount.present? ? "#{@show.staffing_debt_amount} staffing debt(s)" : "No staffing debts" %>
            </p>
        <% end %>
    <% end %>

    <% extra_fields[:debt_settings] = { type: 'content', header: 'Debt Settings', content: yield(:debt_settings) } %>
<% end %>

<%= render('admin/events/basic_show', event: @show, extra_fields: extra_fields) %>
